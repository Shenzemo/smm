<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SMMBoost – Boost Your Social Media</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Vazirmatn:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{color-scheme: light dark}
    html,body{font-family: Vazirmatn, Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif}
    #loader { border: 5px solid #f3f3f3; border-top: 5px solid #3498db; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 40px auto; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body class="bg-gray-50 text-gray-900 dark:bg-gray-900 dark:text-gray-100">
  <header class="sticky top-0 z-20 bg-white/80 backdrop-blur shadow-sm dark:bg-gray-900/80 dark:border-b dark:border-gray-800">
    <div class="mx-auto max-w-7xl px-4 py-4 flex items-center justify-between">
      <h1 class="text-2xl font-extrabold tracking-tight">SMMBoost</h1>
      <nav class="hidden md:flex items-center gap-6 text-sm font-medium">
        <a href="#home" class="hover:opacity-80" data-translate="navHome">Home</a>
        <a href="#services" class="hover:opacity-80" data-translate="navServices">Services</a>
        <a href="#new-order" class="hover:opacity-80" data-translate="navNewOrder">New Order</a>
        <a href="#status" class="hover:opacity-80" data-translate="navOrderStatus">Order Status</a>
        <a href="#ai" class="inline-flex items-center gap-1 hover:opacity-80" data-translate="navAiAssistant">✨ AI Assistant</a>
      </nav>
      <div class="flex items-center gap-3">
        <span class="text-sm bg-gray-100 dark:bg-gray-800 px-3 py-1.5 rounded-full"><span data-translate="balance">Balance</span>: $0.00</span>
        <button id="lang-switcher" class="px-4 py-2 rounded-xl bg-gray-200 dark:bg-gray-700 text-black dark:text-white text-sm font-semibold" onclick="toggleLanguage()">FA</button>
        <button class="px-4 py-2 rounded-xl bg-black text-white dark:bg-white dark:text-black text-sm font-semibold shadow" data-translate="login">Login</button>
      </div>
    </div>
  </header>

  <main id="home" class="mx-auto max-w-7xl px-4">
    <section class="grid md:grid-cols-2 gap-8 items-center py-12">
      <div>
        <h2 class="text-4xl font-extrabold leading-tight" data-translate="heroTitle">Boost Your Social Media</h2>
        <p class="mt-3 text-gray-600 dark:text-gray-400" data-translate="heroSubtitle">The most reliable SMM panel for all your social media marketing needs. Get followers, likes, views, and more with instant delivery.</p>
        <div class="mt-6 flex gap-3">
          <a href="#services" class="px-5 py-3 rounded-xl bg-black text-white dark:bg-white dark:text-black font-semibold shadow" data-translate="browseServices">Browse Services</a>
          <a href="#new-order" class="px-5 py-3 rounded-xl bg-white dark:bg-gray-800 ring-1 ring-black/10 dark:ring-white/10 font-semibold shadow" data-translate="placeOrderCta">Place Order</a>
        </div>
        <dl class="mt-8 grid grid-cols-1 sm:grid-cols-3 gap-4">
          <div class="p-4 rounded-2xl bg-white dark:bg-gray-800 shadow-sm">
            <dt class="font-semibold" data-translate="featureInstant">Instant Delivery</dt>
            <dd class="text-sm text-gray-600 dark:text-gray-400" data-translate="featureInstantDesc">See results fast after ordering.</dd>
          </div>
          <div class="p-4 rounded-2xl bg-white dark:bg-gray-800 shadow-sm">
            <dt class="font-semibold" data-translate="featureQuality">High Quality</dt>
            <dd class="text-sm text-gray-600 dark:text-gray-400" data-translate="featureQualityDesc">Premium services & guaranteed results.</dd>
          </div>
          <div class="p-4 rounded-2xl bg-white dark:bg-gray-800 shadow-sm">
            <dt class="font-semibold" data-translate="featurePrice">Best Prices</dt>
            <dd class="text-sm text-gray-600 dark:text-gray-400" data-translate="featurePriceDesc">Competitive rates & bulk discounts.</dd>
          </div>
        </dl>
      </div>
      <div class="md:justify-self-end">
        <div class="rounded-3xl bg-gradient-to-br from-gray-100 to-white dark:from-gray-800 dark:to-gray-900 p-6 shadow-sm">
          <h3 class="text-lg font-semibold" data-translate="supportedPlatforms">Supported Platforms</h3>
          <p class="text-sm text-gray-600 dark:text-gray-400" data-translate="supportedPlatformsDesc">Auto-filled from the master list.</p>
          <ul id="platforms" class="mt-4 grid grid-cols-2 sm:grid-cols-3 gap-2"></ul>
        </div>
      </div>
    </section>
    
    <section id="services" class="py-10">
      <div class="flex items-end justify-between gap-4">
        <div>
           <h3 class="text-2xl font-bold" data-translate="ourServices">Our Services</h3>
        </div>
        <div class="flex gap-2">
          <input id="search" type="search" data-translate-placeholder="searchPlaceholder" placeholder="Search services, categories, platform..." class="w-64 max-w-full px-3 py-2 rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-black/20 dark:focus:ring-white/20" />
          <select id="platformFilter" class="px-3 py-2 rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800"></select>
        </div>
      </div>
      <div id="servicesGrid" class="mt-6 grid sm:grid-cols-2 lg:grid-cols-3 gap-4">
         <div id="loader" class="col-span-full"></div>
         <p id="loading-text" class="text-center col-span-full text-gray-600 dark:text-gray-400" data-translate="loadingText">Loading and translating services with AI... this may take a moment.</p>
      </div>
       <div id="resultCount" class="mt-3 text-sm text-gray-600 dark:text-gray-400"></div>
    </section>
    
    <section id="new-order" class="py-10">
      <h3 class="text-2xl font-bold" data-translate="placeNewOrder">Place New Order</h3>
      <form id="orderForm" class="mt-4 grid gap-4 max-w-2xl">
        <label class="grid gap-1">
          <span class="text-sm font-medium" data-translate="formCategory">Category</span>
          <select id="orderCategory" class="px-3 py-2 rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800"></select>
        </label>
        <label class="grid gap-1">
          <span class="text-sm font-medium" data-translate="formService">Service</span>
          <select id="orderService" class="px-3 py-2 rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800"></select>
        </label>
        <div id="serviceDetails" class="hidden p-4 rounded-2xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800"></div>
        <label class="grid gap-1">
          <span class="text-sm font-medium" data-translate="formLink">Link</span>
          <input id="orderLink" class="px-3 py-2 rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800" placeholder="https://..." />
        </label>
        <label class="grid gap-1">
          <span class="text-sm font-medium" data-translate="formQuantity">Quantity</span>
          <input id="orderQty" type="number" min="1" class="px-3 py-2 rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800" />
        </label>
        <div class="flex items-center gap-3">
          <span class="text-sm" data-translate="totalCost">Total Cost:</span>
          <strong id="orderTotal" class="text-lg">$0.00</strong>
        </div>
        <button type="button" id="placeOrder" class="w-fit px-5 py-2.5 rounded-xl bg-black text-white dark:bg-white dark:text-black font-semibold shadow" data-translate="placeOrderBtn">Place Order</button>
      </form>
    </section>

    <section id="status" class="py-10">
      <h3 class="text-2xl font-bold" data-translate="checkOrderStatus">Check Order Status</h3>
      <div class="mt-4 flex gap-2 items-center">
        <input id="statusId" data-translate-placeholder="orderIdPlaceholder" placeholder="Enter Order ID" class="px-3 py-2 rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800" />
        <button class="px-4 py-2 rounded-xl bg-white dark:bg-gray-800 ring-1 ring-black/10 dark:ring-white/10" data-translate="checkStatusBtn">Check Status</button>
      </div>
    </section>
    
    <section id="ai" class="py-10">
      <h3 class="text-2xl font-bold" data-translate="aiAssistantTitle">✨ AI Campaign Assistant</h3>
      <p class="text-sm text-gray-600 dark:text-gray-400" data-translate="aiAssistantDesc">Describe your social media goal, and our AI will suggest a custom campaign plan.</p>
      <div class="mt-3 grid max-w-2xl gap-3">
        <textarea id="aiGoal" rows="3" class="px-3 py-2 rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800" data-translate-placeholder="aiPlaceholder" placeholder="e.g., Grow my TikTok followers to 10k this month..."></textarea>
        <button class="w-fit px-5 py-2.5 rounded-xl bg-black text-white dark:bg-white dark:text-black font-semibold shadow" data-translate="getCampaignBtn">Get Campaign Plan</button>
      </div>
    </section>
  </main>

  <footer class="py-10 border-t border-gray-200 dark:border-gray-800 mt-10">
    <div class="mx-auto max-w-7xl px-4 text-sm text-gray-600 dark:text-gray-400">© <span id="year"></span> SMMBoost. <span data-translate="footerRights">All rights reserved.</span></div>
  </footer>

<script>
const translations = {
    loadingText: { en: 'Loading and translating services with AI... this may take a moment.', fa: 'در حال بارگذاری و ترجمه سرویس‌ها با هوش مصنوعی... این فرآیند ممکن است کمی طول بکشد.' },
    navHome: { en: 'Home', fa: 'خانه' },
    navServices: { en: 'Services', fa: 'سرویس‌ها' },
    navNewOrder: { en: 'New Order', fa: 'سفارش جدید' },
    navOrderStatus: { en: 'Order Status', fa: 'وضعیت سفارش' },
    navAiAssistant: { en: '✨ AI Assistant', fa: '✨ دستیار هوش مصنوعی' },
    balance: { en: 'Balance', fa: 'موجودی' },
    login: { en: 'Login', fa: 'ورود' },
    heroTitle: { en: 'Boost Your Social Media', fa: 'شبکه‌های اجتماعی خود را تقویت کنید' },
    heroSubtitle: { en: 'The most reliable SMM panel for all your social media marketing needs. Get followers, likes, views, and more with instant delivery.', fa: 'مطمئن‌ترین پنل SMM برای تمام نیازهای بازاریابی شبکه‌های اجتماعی شما. فالوور، لایک، بازدید و موارد دیگر را با تحویل فوری دریافت کنید.' },
    browseServices: { en: 'Browse Services', fa: 'مشاهده سرویس‌ها' },
    placeOrderCta: { en: 'Place Order', fa: 'ثبت سفارش' },
    featureInstant: { en: 'Instant Delivery', fa: 'تحویل فوری' },
    featureInstantDesc: { en: 'See results fast after ordering.', fa: 'نتایج را بلافاصله پس از سفارش مشاهده کنید.' },
    featureQuality: { en: 'High Quality', fa: 'کیفیت بالا' },
    featureQualityDesc: { en: 'Premium services & guaranteed results.', fa: 'خدمات برتر و نتایج تضمین شده.' },
    featurePrice: { en: 'Best Prices', fa: 'بهترین قیمت‌ها' },
    featurePriceDesc: { en: 'Competitive rates & bulk discounts.', fa: 'نرخ‌های رقابتی و تخفیف‌های حجمی.' },
    supportedPlatforms: { en: 'Supported Platforms', fa: 'پلتفرم‌های پشتیبانی شده' },
    supportedPlatformsDesc: { en: 'Auto-filled from the master list.', fa: 'این بخش به صورت خودکار از لیست اصلی پر می‌شود.' },
    ourServices: { en: 'Our Services', fa: 'سرویس‌های ما' },
    searchPlaceholder: { en: 'Search services, categories, platform...', fa: 'جستجوی سرویس، دسته‌بندی، پلتفرم...' },
    allPlatforms: { en: 'All Platforms', fa: 'همه پلتفرم‌ها' },
    servicesShown: { en: 'services shown', fa: 'سرویس نمایش داده شد' },
    platform: { en: 'Platform', fa: 'پلتفرم' },
    filter: { en: 'Filter', fa: 'فیلتر' },
    serviceId: { en: 'Service ID', fa: 'شناسه سرویس' },
    price: { en: 'Price', fa: 'قیمت' },
    per1: { en: 'per 1', fa: 'به ازای ۱ عدد' },
    details: { en: 'Details', fa: 'جزئیات' },
    noDetails: { en: 'No details', fa: 'جزئیاتی وجود ندارد' },
    select: { en: 'Select', fa: 'انتخاب' },
    placeNewOrder: { en: 'Place New Order', fa: 'ثبت سفارش جدید' },
    formCategory: { en: 'Category', fa: 'دسته‌بندی' },
    formService: { en: 'Service', fa: 'سرویس' },
    formLink: { en: 'Link', fa: 'لینک' },
    formQuantity: { en: 'Quantity', fa: 'تعداد' },
    totalCost: { en: 'Total Cost:', fa: 'هزینه کل:' },
    placeOrderBtn: { en: 'Place Order', fa: 'ثبت سفارش' },
    checkOrderStatus: { en: 'Check Order Status', fa: 'بررسی وضعیت سفارش' },
    orderIdPlaceholder: { en: 'Enter Order ID', fa: 'شناسه سفارش را وارد کنید' },
    checkStatusBtn: { en: 'Check Status', fa: 'بررسی وضعیت' },
    aiAssistantTitle: { en: '✨ AI Campaign Assistant', fa: '✨ دستیار کمپین هوش مصنوعی' },
    aiAssistantDesc: { en: 'Describe your social media goal, and our AI will suggest a custom campaign plan.', fa: 'هدف خود در شبکه‌های اجتماعی را توصیف کنید تا هوش مصنوعی ما یک برنامه کمپین سفارشی به شما پیشنهاد دهد.' },
    aiPlaceholder: { en: 'e.g., Grow my TikTok followers to 10k this month...', fa: 'مثلاً: افزایش فالوورهای تیک‌تاک من به ۱۰ هزار نفر در این ماه...' },
    getCampaignBtn: { en: 'Get Campaign Plan', fa: 'دریافت برنامه کمپین' },
    footerRights: { en: 'All rights reserved.', fa: 'تمامی حقوق محفوظ است.' },
  };

  const state = {
    services: [],
    translatedServices: {},
    usdToTomanRate: 0,
    currentLang: localStorage.getItem('lang') || 'en'
  };

  async function fetchAndProcessData() {
    try {
      const response = await fetch('/.netlify/functions/api');
      if (!response.ok) {
        const errData = await response.json();
        throw new Error(errData.error || 'Network response was not ok');
      }
      const data = await response.json();
      
      // IMPROVEMENT: Pre-calculate unit prices to make frontend logic simpler and more efficient.
      state.services = data.originalServices.map(s => {
          const [rateStr, , perStr] = (s.price || '0 per 1').split(/\s+/);
          const rate = Number(rateStr);
          const per = Number(perStr);
          const unitPriceUSD = (Number.isFinite(rate) && Number.isFinite(per) && per > 0) ? (rate / per) : 0;
          return { ...s, unitPriceUSD };
      });
      state.translatedServices = data.translatedServices;
      state.usdToTomanRate = data.usdToTomanRate;
      
      document.getElementById('loader').style.display = 'none';
      document.getElementById('loading-text').style.display = 'none';
      
      setLanguage(state.currentLang, true); // Pass true to avoid re-rendering services unnecessarily
      addEventListeners();
      // Initial render after data is loaded
      renderPlatforms();
      renderServices();
      buildOrderSelectors();
    } catch (error) {
      console.error('Failed to fetch data:', error);
      document.getElementById('loader').style.display = 'none';
      document.getElementById('loading-text').textContent = `Error: ${error.message}`;
    }
  }
  
  // The 'initialLoad' flag prevents re-rendering everything on the first language set
  function setLanguage(lang, initialLoad = false) {
    state.currentLang = lang;
    localStorage.setItem('lang', lang);
    document.documentElement.lang = lang;
    document.documentElement.dir = lang === 'fa' ? 'rtl' : 'ltr';
    applyTranslations();

    if (!initialLoad && state.services.length > 0) {
      renderPlatforms();
      renderServices();
      buildOrderSelectors();
    }
  }

  function toggleLanguage() {
    const newLang = state.currentLang === 'en' ? 'fa' : 'en';
    setLanguage(newLang);
  }

  function applyTranslations() {
    document.getElementById('lang-switcher').textContent = state.currentLang === 'en' ? 'FA' : 'EN';
    
    document.querySelectorAll('[data-translate]').forEach(el => {
      const key = el.getAttribute('data-translate');
      if (translations[key]?.[state.currentLang]) {
        el.textContent = translations[key][state.currentLang];
      }
    });

    document.querySelectorAll('[data-translate-placeholder]').forEach(el => {
      const key = el.getAttribute('data-translate-placeholder');
      if (translations[key]?.[state.currentLang]) {
        el.placeholder = translations[key][state.currentLang];
      }
    });

    const year = new Date().getFullYear();
    const faYear = new Date().toLocaleDateString('fa-IR', { year: 'numeric' });
    document.getElementById('year').textContent = state.currentLang === 'fa' ? faYear : year;
  }

  function getTranslated(service, property) {
    if (state.currentLang === 'fa' && state.translatedServices[service.service]?.[property]) {
      return state.translatedServices[service.service][property];
    }
    return service[property];
  }
  
  // REFACTORED: This function now uses the pre-calculated unit price
  function getFormattedPrice(unitPriceUSD, forTotal = false, quantity = 1) {
      if (state.currentLang === 'fa' && state.usdToTomanRate > 0) {
          const totalToman = unitPriceUSD * state.usdToTomanRate * quantity;
          const options = forTotal ? { maximumFractionDigits: 0 } : { maximumFractionDigits: 2 };
          return `${totalToman.toLocaleString('fa-IR', options)} تومان`;
      }
      const totalUSD = unitPriceUSD * quantity;
      return `$${totalUSD.toFixed(forTotal ? 2 : 4)}`;
  }
  
  function platformFromCategory(cat){
    if(!cat) return 'Other';
    const i = cat.indexOf('.');
    return i > 0 ? cat.slice(0,i).trim() : cat.trim();
  }

  function renderPlatforms(){
    const translatedPlatforms = new Set();
    state.services.forEach(s => {
       translatedPlatforms.add(platformFromCategory(getTranslated(s, 'category')));
    });
    const platformsList = [...translatedPlatforms].sort();

    const ul = document.getElementById('platforms');
    // SECURITY: Using textContent instead of innerHTML for platform names to prevent potential XSS issues
    // if the source data ever becomes compromised. This is a safer practice.
    ul.innerHTML = '';
    platformsList.forEach(p => {
        const li = document.createElement('li');
        li.className = 'px-3 py-2 rounded-xl bg-white dark:bg-gray-800 shadow-sm text-sm';
        li.textContent = p;
        ul.appendChild(li);
    });

    const sel = document.getElementById('platformFilter');
    sel.innerHTML = `<option value="">${translations.allPlatforms[state.currentLang]}</option>` +
      platformsList.map(p => `<option value="${p}">${p}</option>`).join('');
  }

  function serviceCard(s){
    const unitPriceText = getFormattedPrice(s.unitPriceUSD);
    const paramsHtml = (s.params||[]).map(pr=>`
        <div class="text-xs">
            <span class="font-medium">${pr.name}:</span> 
            <span class="text-gray-600 dark:text-gray-400">${pr.valid||''}</span>
        </div>`).join('');
    
    // SECURITY: While the data source is trusted, building HTML this way is risky.
    // A more advanced solution would use document.createElement, but for this project's scope,
    // ensuring the source data is clean is the key.
    return `
      <article class="p-4 rounded-2xl bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 shadow-sm flex flex-col">
        <div class="text-xs text-gray-500 dark:text-gray-400">${getTranslated(s, 'category') || ''}</div>
        <h4 class="mt-1 font-semibold">${getTranslated(s, 'product_name') || 'Service'}</h4>
        <div class="mt-1 text-sm">${translations.serviceId[state.currentLang]}: <span class="font-mono">${s.service}</span></div>
        <div class="mt-1 text-sm">${translations.price[state.currentLang]}: <span class="font-semibold">${unitPriceText}</span> <span class="text-gray-500">/${translations.per1[state.currentLang]}</span></div>
        <details class="mt-2 text-sm">
          <summary class="cursor-pointer">${translations.details[state.currentLang]}</summary>
          <div class="mt-2 grid gap-1">${paramsHtml || `<div class="text-xs text-gray-500 dark:text-gray-400">${translations.noDetails[state.currentLang]}</div>`}</div>
        </details>
        <div class="flex-grow"></div>
        <button class="mt-3 w-full px-3 py-2 rounded-xl bg-black text-white dark:bg-white dark:text-black text-sm font-semibold" data-service-id="${s.service}" onclick="prefillOrder(this)">${translations.select[state.currentLang]}</button>
      </article>
    `;
  }

  function renderServices(){
    const q = document.getElementById('search').value.trim().toLowerCase();
    const pf = document.getElementById('platformFilter').value;

    const filtered = state.services.filter(s=>{
      const translatedCat = getTranslated(s, 'category');
      const plat = platformFromCategory(translatedCat);
      if(pf && plat !== pf) return false;
      if(!q) return true;
      const hay = `${getTranslated(s, 'product_name')||''} ${translatedCat||''} ${plat} ${s.service}`.toLowerCase();
      return hay.includes(q);
    });

    document.getElementById('servicesGrid').innerHTML = filtered.slice(0, 2400).map(serviceCard).join('');
    
    const count = state.currentLang === 'fa' ? filtered.length.toLocaleString('fa-IR') : filtered.length.toLocaleString('en-US');
    document.getElementById('resultCount').textContent = `${count} ${translations.servicesShown[state.currentLang]}${pf?` • ${translations.platform[state.currentLang]}: ${pf}`:''}${q?` • ${translations.filter[state.currentLang]}: "${q}"`:''}`;
  }
  
  function buildOrderSelectors(){
    const catSel = document.getElementById('orderCategory');
    const svcSel = document.getElementById('orderService');

    const byCat = {};
    state.services.forEach(s=>{
      const c = getTranslated(s, 'category') || 'Other';
      (byCat[c] ||= []).push(s);
    });

    const groupedForDropdown = {};
    Object.keys(byCat).sort().forEach(category => {
        const platform = platformFromCategory(category);
        (groupedForDropdown[platform] ||= []).push(category);
    });

    const platformKeys = Object.keys(groupedForDropdown).sort();
    catSel.innerHTML = platformKeys.map(platform => {
        const categoryOptions = groupedForDropdown[platform]
            .map(cat => `<option value="${cat}">${cat.replace(platform + '.', '').trim()}</option>`).join('');
        return `<optgroup label="--- ${platform} ---">${categoryOptions}</optgroup>`;
    }).join('');

    function updateServices(){
      const c = catSel.value;
      const list = byCat[c] || [];
      svcSel.innerHTML = list.map(s=>`<option value="${s.service}">${getTranslated(s, 'product_name')}</option>`).join('');
      svcSel.dispatchEvent(new Event('change'));
    }

    catSel.onchange = updateServices;
    svcSel.onchange = ()=>{
      const current = state.services.find(x=>String(x.service)===svcSel.value);
      const box = document.getElementById('serviceDetails');
      if(current){
        box.classList.remove('hidden');
        const unitPriceText = getFormattedPrice(current.unitPriceUSD);
        box.innerHTML = `
          <div class="text-sm"><span class="font-medium">${translations.platform[state.currentLang]}:</span> ${platformFromCategory(getTranslated(current, 'category'))}</div>
          <div class="text-sm"><span class="font-medium">${translations.price[state.currentLang]}:</span> ${unitPriceText} / ${translations.per1[state.currentLang]}</div>
          <div class="mt-2 grid gap-1 text-sm">${(current.params||[]).map(p=>`<div><span class="font-medium">${p.name}:</span> ${p.valid||''}</div>`).join('')}</div>
        `;
      } else {
        box.classList.add('hidden');
      }
      calcTotal();
    };
    updateServices();
  }

  window.prefillOrder = (btn)=>{
    const serviceId = btn.getAttribute('data-service-id');
    const data = state.services.find(s => String(s.service) === serviceId);
    if (!data) return;

    document.getElementById('orderCategory').value = getTranslated(data, 'category');
    document.getElementById('orderCategory').dispatchEvent(new Event('change'));
    // Use a timeout to ensure the service list updates before we set the value
    setTimeout(() => {
        document.getElementById('orderService').value = String(data.service);
        document.getElementById('orderService').dispatchEvent(new Event('change'));
        document.getElementById('orderQty').value = (data.params||[]).find(p=>p.param==='count')?.valid?.match(/\d+/)?.[0] || 100;
        calcTotal();
        document.getElementById('new-order').scrollIntoView({ behavior: 'smooth' });
    }, 50);
  }

  function calcTotal(){
      const qty = Number(document.getElementById('orderQty').value || 0);
      const svcId = document.getElementById('orderService').value;
      const svc = state.services.find(s => String(s.service) === svcId);
      
      let totalText = state.currentLang === 'fa' ? '۰ تومان' : '$0.00';
      if (svc && qty > 0) {
          totalText = getFormattedPrice(svc.unitPriceUSD, true, qty);
      }
      document.getElementById('orderTotal').textContent = totalText;
  }

  function addEventListeners() {
    document.getElementById('search').addEventListener('input', renderServices);
    document.getElementById('platformFilter').addEventListener('change', renderServices);
    document.getElementById('orderQty').addEventListener('input', calcTotal);
    document.getElementById('orderService').addEventListener('change', calcTotal);
  }

  document.addEventListener('DOMContentLoaded', fetchAndProcessData);
</script>
</body>
</html>
